import{u as ce}from"./_4LJ9EKD.js";import{g as pe,r as $,G as K,j as M,k as de,c as y,b as s,x as h,p as v,w as a,A as p,l as D,m,H as fe,o as u,a as B,d as i,t as w,n as k,v as j,F as P,s as me,q as _e,R as U,O as Q,_ as ye}from"#entry";import{L as ge}from"./BAlS7_RU.js";const ve={class:"subscriptions-page"},ke={class:"filter-section"},he={key:2,class:"url-cell"},we={key:0},xe={key:1,class:"text-muted"},be={key:0,class:"text-success"},Ce={key:1},Le={key:2,class:"text-muted"},Te={class:"batch-actions"},$e=pe({__name:"subscriptions",setup(Se){fe(),ce();const C=$(!1),S=$(!1),x=$([]),g=$([]),d=K({type:"",permanent:"",search:""}),O=K({current:1,pageSize:10,total:0,showSizeChanger:!0,showQuickJumper:!0,showTotal:(t,e)=>`第 ${e[0]}-${e[1]} 条，共 ${t} 条`}),W=[{title:"类型",dataIndex:"type",key:"type",width:80,align:"center"},{title:"链接类型",dataIndex:"permanent",key:"permanent",width:100,align:"center"},{title:"订阅链接",dataIndex:"url",key:"url",ellipsis:!0},{title:"参数",dataIndex:"params",key:"params",width:200},{title:"创建时间",dataIndex:"created_at",key:"created_at",width:150,sorter:(t,e)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime()},{title:"过期时间",dataIndex:"expires_at",key:"expires_at",width:150},{title:"状态",dataIndex:"status",key:"status",width:100,align:"center"},{title:"操作",key:"actions",width:200,align:"center"}],A=M(()=>{let t=g.value;if(d.type&&(t=t.filter(e=>e.type===d.type)),d.permanent!==""&&(t=t.filter(e=>e.permanent===d.permanent)),d.search){const e=d.search.toLowerCase();t=t.filter(n=>n.url.toLowerCase().includes(e)||JSON.stringify(n.params).toLowerCase().includes(e))}return t}),L=M(()=>{const t=g.value.length,e=g.value.filter(o=>o.type==="clash").length,n=g.value.filter(o=>o.type==="v2ray").length,l=g.value.filter(o=>o.permanent).length;return{total:t,clash:e,v2ray:n,permanent:l}}),I=async()=>{C.value=!0;try{const t=localStorage.getItem("token");if(!t){p.error("请先登录");return}const l=`${D().public.apiBase}/subscription_links`;console.log("请求订阅链接API:",l),console.log("Token:",t?"已获取":"未获取");const o=await fetch(l,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(console.log("响应状态:",o.status),console.log("响应头:",o.headers),!o.ok){const _=await o.text();throw console.error("API错误响应:",_),new Error(`HTTP error! status: ${o.status}`)}const c=await o.json();console.log("API响应数据:",c),c.success?(g.value=c.links.map(_=>({..._,refreshing:!1})),O.total=c.links.length):p.error(c.message||"获取订阅链接失败")}catch(t){console.error("加载订阅链接失败:",t),p.error("加载订阅链接失败")}finally{C.value=!1}},X=()=>{I()},Y=()=>{},Z=()=>{d.type="",d.permanent="",d.search=""},R=async t=>{try{await navigator.clipboard.writeText(t),p.success("链接已复制到剪贴板")}catch(e){console.error("复制失败:",e),p.error("复制失败")}},E=async t=>{t.refreshing=!0;try{const e=localStorage.getItem("token"),l=D().public.apiBase,c=await(await fetch(`${l}/subscription_links/${t.id}/refresh`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}})).json();c.success?(t.url=c.new_url,p.success("订阅链接刷新成功")):p.error(c.message||"刷新失败")}catch(e){console.error("刷新失败:",e),p.error("刷新失败")}finally{t.refreshing=!1}},V=async t=>{try{const e=localStorage.getItem("token");if(!e){p.error("请先登录");return}const l=D().public.apiBase,c=await(await fetch(`${l}/subscription_links/${t.id}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}})).json();c.success?(p.success(c.message||"订阅链接删除成功"),await I()):p.error(c.message||"删除失败")}catch(e){console.error("删除失败:",e),p.error("删除失败")}},ee=()=>{const t=x.value.map(e=>g.value.find(n=>n.id===e)?.url).filter(Boolean).join(`
`);R(t)},te=async()=>{S.value=!0;try{const t=x.value.map(e=>{const n=g.value.find(l=>l.id===e);return n?E(n):Promise.resolve()});await Promise.all(t),p.success("批量刷新完成")}catch{p.error("批量刷新失败")}finally{S.value=!1}},ae=async()=>{try{const t=x.value.map(e=>{const n=g.value.find(l=>l.id===e);return n?V(n):Promise.resolve()});await Promise.all(t),x.value=[],p.success("批量删除完成")}catch{p.error("批量删除失败")}},se=t=>new Date(t).toLocaleString("zh-CN"),ne=t=>t.permanent?"green":N(t)?"red":z(t)?"orange":"blue",oe=t=>t.permanent?"有效":N(t)?"已过期":z(t)?"即将过期":"有效",N=t=>t.permanent||!t.expires_at?!1:new Date(t.expires_at)<new Date,z=t=>{if(t.permanent||!t.expires_at)return!1;const e=new Date,l=new Date(t.expires_at).getTime()-e.getTime();return l>0&&l<1800*1e3};return de(()=>{I()}),(t,e)=>{const n=m("a-button"),l=m("a-statistic"),o=m("a-col"),c=m("a-row"),_=m("a-select-option"),F=m("a-select"),le=m("a-input-search"),T=m("a-tag"),re=m("a-input"),H=m("a-popconfirm"),J=m("a-space"),ie=m("a-table"),ue=m("a-empty"),q=m("a-card");return u(),y("div",ve,[s(q,{title:"订阅链接管理",class:"main-card"},{extra:a(()=>[s(n,{type:"primary",onClick:X},{icon:a(()=>[s(k(U))]),default:a(()=>[e[4]||(e[4]=i(" 刷新 ",-1))]),_:1})]),default:a(()=>[s(c,{gutter:16,class:"stats-row"},{default:a(()=>[s(o,{span:6},{default:a(()=>[s(l,{title:"总订阅数",value:L.value.total},null,8,["value"])]),_:1}),s(o,{span:6},{default:a(()=>[s(l,{title:"Clash订阅",value:L.value.clash},null,8,["value"])]),_:1}),s(o,{span:6},{default:a(()=>[s(l,{title:"V2Ray订阅",value:L.value.v2ray},null,8,["value"])]),_:1}),s(o,{span:6},{default:a(()=>[s(l,{title:"永久链接",value:L.value.permanent},null,8,["value"])]),_:1})]),_:1}),B("div",ke,[s(c,{gutter:16,align:"middle"},{default:a(()=>[s(o,{span:6},{default:a(()=>[s(F,{value:d.type,"onUpdate:value":e[0]||(e[0]=f=>d.type=f),placeholder:"选择类型","allow-clear":"",style:{width:"100%"}},{default:a(()=>[s(_,{value:""},{default:a(()=>[...e[5]||(e[5]=[i("全部类型",-1)])]),_:1}),s(_,{value:"clash"},{default:a(()=>[...e[6]||(e[6]=[i("Clash",-1)])]),_:1}),s(_,{value:"v2ray"},{default:a(()=>[...e[7]||(e[7]=[i("V2Ray",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),s(o,{span:6},{default:a(()=>[s(F,{value:d.permanent,"onUpdate:value":e[1]||(e[1]=f=>d.permanent=f),placeholder:"链接类型","allow-clear":"",style:{width:"100%"}},{default:a(()=>[s(_,{value:""},{default:a(()=>[...e[8]||(e[8]=[i("全部",-1)])]),_:1}),s(_,{value:!0},{default:a(()=>[...e[9]||(e[9]=[i("永久链接",-1)])]),_:1}),s(_,{value:!1},{default:a(()=>[...e[10]||(e[10]=[i("临时链接",-1)])]),_:1})]),_:1},8,["value"])]),_:1}),s(o,{span:8},{default:a(()=>[s(le,{value:d.search,"onUpdate:value":e[2]||(e[2]=f=>d.search=f),placeholder:"搜索链接或参数","enter-button":"",onSearch:Y},null,8,["value"])]),_:1}),s(o,{span:4},{default:a(()=>[s(n,{onClick:Z},{default:a(()=>[...e[11]||(e[11]=[i("清除筛选",-1)])]),_:1})]),_:1})]),_:1})]),s(ie,{columns:W,"data-source":A.value,loading:C.value,pagination:O,"row-key":"id",class:"subscription-table"},{bodyCell:a(({column:f,record:r})=>[f.key==="type"?(u(),h(T,{key:0,color:r.type==="clash"?"blue":"green"},{default:a(()=>[i(w(r.type==="clash"?"Clash":"V2Ray"),1)]),_:2},1032,["color"])):v("",!0),f.key==="permanent"?(u(),h(T,{key:1,color:r.permanent?"green":"orange"},{default:a(()=>[i(w(r.permanent?"永久":"临时"),1)]),_:2},1032,["color"])):v("",!0),f.key==="url"?(u(),y("div",he,[s(re,{value:r.url,readonly:"",class:"url-input"},null,8,["value"]),s(n,{type:"link",size:"small",onClick:b=>R(r.url)},{icon:a(()=>[s(k(j))]),_:1},8,["onClick"])])):v("",!0),f.key==="params"?(u(),y(P,{key:3},[r.params&&Object.keys(r.params).length>0?(u(),y("div",we,[(u(!0),y(P,null,me(r.params,(b,G)=>(u(),h(T,{key:G,size:"small"},{default:a(()=>[i(w(G)+": "+w(b),1)]),_:2},1024))),128))])):(u(),y("span",xe,"无参数"))],64)):v("",!0),f.key==="expires_at"?(u(),y(P,{key:4},[r.permanent?(u(),y("span",be,"永不过期")):r.expires_at?(u(),y("span",Ce,w(se(r.expires_at)),1)):(u(),y("span",Le,"-"))],64)):v("",!0),f.key==="status"?(u(),h(T,{key:5,color:ne(r),class:_e({blink:z(r)})},{default:a(()=>[i(w(oe(r)),1)]),_:2},1032,["color","class"])):v("",!0),f.key==="actions"?(u(),h(J,{key:6},{default:a(()=>[s(n,{type:"link",size:"small",onClick:b=>R(r.url)},{icon:a(()=>[s(k(j))]),default:a(()=>[e[12]||(e[12]=i(" 复制 ",-1))]),_:1},8,["onClick"]),s(n,{type:"link",size:"small",onClick:b=>E(r),loading:r.refreshing},{icon:a(()=>[s(k(U))]),default:a(()=>[e[13]||(e[13]=i(" 刷新 ",-1))]),_:1},8,["onClick","loading"]),s(H,{title:"确定要删除这个订阅链接吗？",onConfirm:b=>V(r),"ok-text":"确定","cancel-text":"取消"},{default:a(()=>[s(n,{type:"link",size:"small",danger:""},{icon:a(()=>[s(k(Q))]),default:a(()=>[e[14]||(e[14]=i(" 删除 ",-1))]),_:1})]),_:1},8,["onConfirm"])]),_:2},1024)):v("",!0)]),_:1},8,["data-source","loading","pagination"]),!C.value&&A.value.length===0?(u(),h(ue,{key:0,description:"暂无订阅链接",class:"empty-state"},{image:a(()=>[s(k(ge),{style:{"font-size":"64px",color:"#d9d9d9"}})]),default:a(()=>[s(n,{type:"primary",onClick:e[3]||(e[3]=f=>t.$router.push("/"))},{default:a(()=>[...e[15]||(e[15]=[i(" 去生成订阅链接 ",-1)])]),_:1})]),_:1})):v("",!0)]),_:1}),x.value.length>0?(u(),h(q,{key:0,class:"batch-actions-card"},{default:a(()=>[B("div",Te,[B("span",null,"已选择 "+w(x.value.length)+" 项",1),s(J,null,{default:a(()=>[s(n,{onClick:ee},{icon:a(()=>[s(k(j))]),default:a(()=>[e[16]||(e[16]=i(" 批量复制 ",-1))]),_:1}),s(n,{onClick:te,loading:S.value},{icon:a(()=>[s(k(U))]),default:a(()=>[e[17]||(e[17]=i(" 批量刷新 ",-1))]),_:1},8,["loading"]),s(H,{title:"确定要删除选中的订阅链接吗？",onConfirm:ae,"ok-text":"确定","cancel-text":"取消"},{default:a(()=>[s(n,{danger:""},{icon:a(()=>[s(k(Q))]),default:a(()=>[e[18]||(e[18]=i(" 批量删除 ",-1))]),_:1})]),_:1})]),_:1})])]),_:1})):v("",!0)])}}}),De=ye($e,[["__scopeId","data-v-fc9f453e"]]);export{De as default};
